---
title: '关于X-Forwarded-For的安全性问题'
keywords: [http,X-Forwarded-For]
date: 2023-03-09
draft: true
---

近段时间偶尔会收到客服反馈，有用户打开某个页面白屏，通过切换网络，或者禁用网络后在启用网络，有时间可以解决问题。从现象看第一反应可能是用户网络问题，但是客服和用户沟通后，用户的网络是正常的，并且我司的其他页面也可以打开。从用户数量上看，这个反馈有增多的趋势，需要技术人员协助排查。通过联系客服给的用户，终于在技术人员的见证下，在用户的机器上复现了问题。

## 确认问题原因

在用户的积极配合下，在手机上安装抓包软件，终于发现了问题所在。某个接口返回结果异常，通过URL定位到系统，然后从日志中发现是用户IP格式异常。
在日志平台中定位到用户的访问日志：

```
http_user_agent	  okhttp/3.12.0
http_x_forwarded_for	  2409:8a20:505a:d670:f575:c529:4866:545d, 223.111.166.45
```

我们这个系统没有使用CDN，所以`x_forwarded_for`应该是空值，不可能出现有IP的情况。通过走读系统源码，我们认为`x_forwarded_for`中的第一个IP是用户的出口IP。因此，针对改用户的请求，系统认为用户的IP是`2409:8a20:505a:d670:f575:c529:4866:545d`,我们的系统刚好是IP敏感的，目前还不支持IPv6，所以在解析IP时出现了错误。

该系统在生产环境的部署情况是这样的，用户->http负载均衡->系统服务器。http负载均衡会把`remote_addr`添加到`x_forwarded_for`中，所以解决方案就是我们直接获取`x_forwarded_for`中最后一个IP。

## 进一步思考

CDN节点、http中间件默认都是按照标准在`x_forwarded_for`后追加IP。"用户"在发出请求时，自己也可以加`x_forwarded_for`。比如`curl -v --header "X-Forwarded-For: 223.111.166.45"  http://www.example.com/`,通过这行命令发出的请求，经过多层中间件之后，服务器代码可能看到的是这样的`X-Forwarded-For: 223.111.166.45,127.0.0.1,45.25.14.45`。按照上面那个系统之前获取IP的方法，获取到的IP其实是错误的，是用户伪造的。由于出口IP难于伪造，所以IP是风控中非常重要的一个参数。该系统获取到错误的IP，所以可能会导致风控失效。

那要怎样才能获取到用户真实的出口IP呢？需要结合系统的部署情况分布处理：

1. 用户直连服务器，一般在测试环境这样使用，直接使用`remote_addr`
2. 经过一层负载均衡后，到服务器，负载均衡按照标准添加`x_forwarded_for`，使用`x_forwarded_for`的最后一项
3. 使用了CDN或者其他http中间件，这个时候需要建立IP白名单，从后往前遍历`x_forwarded_for`找到第一个不在白名单中的IP。当然建立并且维护这个白名单不是个容易的事情。有些商业CDN提供了边缘节点的接口，可以通过脚本定时更新。

参考：

1. https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For
2. https://help.aliyun.com/document_detail/448108.html