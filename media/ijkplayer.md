---
title: ijkplayer 流程分析
date: 2023-04-07
draft: true
---

ijkplayer是B站开源的基于ffplay的移动端播放器SDK，2013年6月开源，活跃到2017年底，之后几乎停滞了。ijkplayer使用的ffmpeg4.0，版本已经很老了。如果想在生产环境使用ijkplayer，起码要升级到6.0，还是要下一番功夫的。

## 播放主流程

按照一般播放器设计，主流程几乎都是下面这样的：

![Player Pipeline](player_pipeline.png)

为了效率，这个流程有几个地方可以简化：

1. 读取音视频和音视频分离器可以合并，这也是大多数播放器的做法
2. 音视频后处理可以集成到音视频渲染器上。顺便提一下，在Windows平台有个著名的视频后处理器VSFilter负责处理字幕
3. 字幕可以直接连接到视频后处理或者视频渲染器上

## 关于线程和缓冲区

播放器必须是个多线程应用。多线程的目的是为了提前填充缓冲区，为了音视频渲染的流畅性。所有线程检测`abort`标记，`abort`标记为`true`，退出线程。一般需要以下几个线程：

1. 播放器主线程，该线程的典型场景是UI线程的调用同步到该线程处理，防止卡死主线程，函数名：`ijkmp_msg_loop`，经过层层调用后进入`ijkmp_get_msg`函数。

    该线程采用事件驱动的方式运行。事件存储在`FFPlayer::msg_queue`中，主要的事件：`prepare`,`start`,`parse`,`seek`。

2. 数据读取线程，一般在音视频分离器里面，函数名：`read_thread`

    该线程也是播放器的初始化线程，获取媒体格式，创建合适的音视频解码器、音频渲染器。由于ffplay一定会有渲染窗口，所以在播放器主线程里面就创建了视频渲染线程，ijkplayer继承了这个特性。该线程向三个缓冲区写入数据：`VideoState::videoq` 视频包缓存区，`VideoState::audioq` 音频包缓冲区，`VideoState::subtitleq` 字幕缓冲区。当三个缓冲区已经填满时（字节数大于某个值或者Packet数量大于某个值）并且播放的非实时流，该线程会主动休眠10毫秒。

    几个注意事项：
    - Packet的pts会发生跳变，需要兼容。可以在这里处理，也可以在播放时处理

3. 视频解码线程，函数名：`video_thread`，经过层层调用后进入核心函数`ffplay_video_thread`。为了充分使用多核特性，视频解码器会创建更多线程配合解码

    从`VideoState::videoq`获取Packet，获取不到时会等待，然后调用`avcodec`解码，接着把已经解码的帧放入`VideoState::pictq`，该缓冲区已满时会等待。不断重复上面的过程，直到收到退出消息。

    几个注意事项：
    - 视频分辨率会变化，需要处理
    - 需要兼容软件和硬件解码
    - 需要兼容更多的frame format

4. 音频解码线程，函数名：`audio_thread`
5. 视频渲染线程，函数名：`video_refresh_thread`
6. 音频渲染线程，该线程是SDL管理的，需要音频数据时回调`sdl_audio_callback`

## 视频渲染器（线程）

视频渲染器管理当前正在渲染的帧以及待渲染帧，ijkplayer中视频的待渲染缓存区是`VideoState::pictq`。待渲染帧就是缓存，除了保证渲染的流畅性，缓存还起到重排序B帧的作用。虽然有些解码器已经把视频帧按照pts排序后，推给视频渲染器，但是为了适应各种不同的解码器，视频解码器不能假设已经排好序了，另外待渲染帧通常使用环形队列实现，并且已经是排好序的，可以从后向前搜索新桢的插入位置，如果没有B帧，搜索一帧就确定了插入位置，最大搜索数量就是B帧的参考帧数量。考虑到播放流畅性和内存占用，目前待渲染帧比较合理的区间是4-10帧。ijkplayer的默认大小是3帧。当缓冲区已满时，一般会阻塞解码线程。

视频渲染器一般有独立的渲染线程，如果操作系统支持线程优先级，需要把渲染线程设置为最高优先级。ijkplayer中的渲染线程函数是 `video_refresh_thread`。ijkplayer的渲染线程最大10ms执行一次渲染任务，包括字幕渲染。渲染线程主要等待两个事件：

1. 播放器退出信号：收到该事件后，退出渲染线程
2. 下一帧渲染时间已到：替换当前渲染帧，立即渲染一次

渲染线程流程图如下：

![Video Render Flow Chart](video_refresh_thread.png)

 

参考：
1. https://zhuanlan.zhihu.com/p/43564980
